<div class="chat-container">
  <div class="chat-header">
    <div class="chat-title">
      <div class="chat-info">
        <button class="back-button" (click)="backToChatList()">
          Back to list
        </button>

        <span class="chat-name">{{ chat.name }}</span>
        <span class="chat-type" *ngIf="chat.isGroup">Group</span>
        <span class="chat-type" *ngIf="!chat.isGroup">DM</span>
      </div>

      <div style="position: relative">
        <button
          class="chat-options"
          (click)="toggleOptionsMenu()"
          *ngIf="this.chat.isGroup"
        >
          ⋮
        </button>
        <div class="chat-options-menu" *ngIf="showOptionsMenu">
          <ul>
            <li (click)="showGroupDescription()">Group Description</li>
            <li (click)="toShowAddUsrPopup()">Add User</li>
            <li (click)="showParticipants()">Participants</li>
            <li (click)="leaveGroup()">Leave Group</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="active-users" *ngIf="chat.isGroup">
      <div
        class="active-user"
        *ngFor="let user of activeUsersInChat.slice(0, 5)"
      >
        {{ user.charAt(0).toUpperCase() }}
      </div>
      <span *ngIf="activeUsersInChat.length > 5">
        +{{ activeUsersInChat.length - 5 }} active
      </span>
    </div>

    <div class="dm-status" *ngIf="!chat.isGroup">
      {{ isOtherOnline ? 'Online' : 'Offline' }}
    </div>
  </div>

  <div class="chat-messages">
    <div
      *ngFor="let message of messages"
      [ngClass]="{
        'message': true,
        'own-message': message.isOwn,
        'system-message': message.sender === 'System',
        'other-message': !message.isOwn && message.sender !== 'System'
      }"
    >
      <!-- הודעות רגילות -->
      <ng-container *ngIf="message.sender !== 'System'; else systemMsg">
        <div class="message-header">
          <strong>{{ message.isOwn ? 'Me' : message.sender }}</strong>
          <span class="message-time">{{ message.timestamp }}</span>
        </div>
        <div class="message-content">
          {{ message.content }}
        </div>
      </ng-container>

      <!-- הודעות מערכת -->
      <ng-template #systemMsg>
        <div class="message-content">
          {{ message.content }}
        </div>
        <div class="message-time">
          {{ message.timestamp }}
        </div>
      </ng-template>
    </div>
  </div>

  <div class="chat-input">
    <input
      type="text"
      [(ngModel)]="newMessage"
      placeholder="Type a message..."
    />
    <button (click)="sendMessage()">Send</button>
  </div>
</div>

<app-description
  *ngIf="showDescriptionPopup"
  [description]="chat.description"
  (close)="showDescriptionPopup = false"
>
</app-description>

<app-add-user-chat
  *ngIf="showAddUsrPopup"
  [filteredUsers]="addUsers"
  (close)="showAddUsrPopup = false"
  (addContact)="handleAddContact($event)"
>
</app-add-user-chat>

<app-participants
  *ngIf="showParticipantsPopup"
  [filteredUsers]="seeUsers"
  [activeUsers]="activeUsersInChat"
  (close)="showParticipantsPopup = false"
  (removeUser)="handleRemoveUser($event)"
>
</app-participants>
